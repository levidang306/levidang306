name: Realtime Development Stats & Dynamic README

on:
  schedule:
    - cron: '30 * * * *'     # Run every hour at 30 minutes past
    - cron: '0 */6 * * *'    # Every 6 hours for comprehensive stats
  push:
    branches: [main]
    paths-ignore:
      - "README.md"
  workflow_dispatch:
    inputs:
      force_update:
        description: "Force update even if no changes detected"
        required: false
        default: "false"
        type: boolean
      update_type:
        description: "Type of update to perform"
        required: false
        default: "full"
        type: choice
        options:
          - full
          - stats_only
          - activity_only

permissions:
  contents: write # Required for committing changes
  actions: read
  issues: read # For better GitHub activity tracking
  pull-requests: read

jobs:
  # WakaTime Stats Integration
  waka-readme:
    name: Update WakaTime Stats
    runs-on: ubuntu-latest
    steps:
      - name: Update WakaTime Stats
        uses: anmol098/waka-readme-stats@master
        with:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          SHOW_OS: "True"
          SHOW_PROJECTS: "True"
          SHOW_TIMEZONE: "True"
          SHOW_LANGUAGE: "True"
          SHOW_LOC_CHART: "True"
          SHOW_COMMIT: "True"
          SHOW_DAYS_OF_WEEK: "True"
          SHOW_LANGUAGE_PER_REPO: "True"
          SHOW_EDITORS: "True"
          SHOW_SHORT_INFO: "True"
          SHOW_PROFILE_VIEWS: "True"
          SHOW_TOTAL_CODE_TIME: "True"
          COMMIT_BY_ME: "True"
          
  # Comprehensive README Update
  update-comprehensive:
    name: Update Comprehensive Stats
    runs-on: ubuntu-latest
    needs: waka-readme
    timeout-minutes: 20
    
    steps:
      - name: ðŸ›’ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ï¿½ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: |
          npm install axios moment cheerio node-fetch
          echo "âœ… Enhanced dependencies installed"

      - name: ðŸ“Š Generate GitHub Stats
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Generating comprehensive GitHub statistics..."
          node -e "
            const { execSync } = require('child_process');
            const fs = require('fs');
            
            // Get repository stats
            const stats = {
              commits: execSync('git rev-list --count HEAD').toString().trim(),
              branches: execSync('git branch -r | wc -l').toString().trim(),
              contributors: execSync('git shortlog -sn | wc -l').toString().trim(),
              files: execSync('find . -type f -name \"*.js\" -o -name \"*.ts\" -o -name \"*.py\" -o -name \"*.java\" | wc -l').toString().trim(),
              lines: execSync('find . -name \"*.js\" -o -name \"*.ts\" -o -name \"*.py\" -o -name \"*.java\" | xargs wc -l | tail -1 | awk \"{print \\$1}\"').toString().trim()
            };
            
            fs.writeFileSync('.github/temp/repo-stats.json', JSON.stringify(stats, null, 2));
            console.log('ðŸ“ˆ Repository stats generated:', stats);
          "

      - name: ðŸŒ Fetch External Data
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p .github/temp
          
          # GitHub comprehensive activity
          echo "ï¿½ Fetching comprehensive GitHub activity..."
          curl -H "Authorization: Bearer $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/users/levidang306/events?per_page=50" \
               > .github/temp/github-activity.json
          
          # GitHub user stats
          curl -H "Authorization: Bearer $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/users/levidang306" \
               > .github/temp/github-user.json
          
          # Repository list for diversity tracking
          curl -H "Authorization: Bearer $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/users/levidang306/repos?sort=updated&per_page=20" \
               > .github/temp/github-repos.json

      - name: ðŸ”„ Run Enhanced Update Script
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          UPDATE_TYPE: ${{ github.event.inputs.update_type || 'full' }}
        run: |
          echo "ðŸš€ Starting comprehensive README update..."
          node .github/scripts/update-readme-advanced.js

      - name: ðŸ“ Check for Changes
        id: check_changes
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
            git diff --stat README.md
          fi

      - name: ï¿½ Commit and Push Changes
        if: steps.check_changes.outputs.changed == 'true' || github.event.inputs.force_update == 'true'
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          
          # Create comprehensive commit message
          commit_msg="ðŸ¤– Auto-update README: $(date -u +'%Y-%m-%d %H:%M UTC')

          ðŸ“Š Updated comprehensive stats:
          - Real-time GitHub activity & repository metrics
          - Development time tracking (WakaTime)
          - Language & technology usage analytics
          - Inspirational tech quote
          
          ðŸ”„ Powered by Advanced GitHub Actions Automation
          âš¡ Update Type: ${{ github.event.inputs.update_type || 'scheduled' }}
          ðŸŽ¯ Trigger: ${{ github.event_name }}"
          
          git commit -m "$commit_msg"
          git push origin main
          echo "ðŸŽ‰ README successfully updated with comprehensive stats!"

      - name: ðŸ“Š Workflow Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ Comprehensive README Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Update Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Update Type**: ${{ github.event.inputs.update_type || 'full' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Applied**: ${{ steps.check_changes.outputs.changed || 'forced' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Completion Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Features Updated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Real-time GitHub activity tracking" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… WakaTime coding statistics" >> $GITHUB_STEP_SUMMARY  
          echo "- âœ… Repository metrics & analytics" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dynamic tech quotes & timestamps" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Language & technology insights" >> $GITHUB_STEP_SUMMARY
          
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -rf .github/temp
          echo "ðŸ—‘ï¸ Temporary files cleaned up"
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected in README.md"
            
            # Show detailed diff stats
            echo "ðŸ“Š **Change Statistics**:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            git diff --stat README.md >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # Show preview of changes (first 10 lines)
            echo "ðŸ” **Preview of Changes**:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`diff" >> $GITHUB_STEP_SUMMARY
            git diff README.md | head -20 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

          # Force update if requested
          if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Force update requested"
            echo "- **Force Update**: âœ… Enabled" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸš€ Commit and Push Changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add README.md with error handling
          if git add README.md; then
            echo "âœ… README.md staged successfully"
          else
            echo "âŒ Failed to stage README.md"
            exit 1
          fi

          # Create enhanced commit message
          COMMIT_MSG="ðŸ¤– Auto-update README: $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          ðŸ“Š **Updated Content**:
          - âš¡ Real-time GitHub activity and statistics
          - â° Enhanced WakaTime coding metrics with visual progress bars
          - ðŸ’­ Fresh inspirational tech quote
          - ðŸ•’ Precise timestamp with timezone
          - ðŸ“ˆ Comprehensive development environment tracking

          ðŸ”„ **Automation**: GitHub Actions workflow
          ðŸŽ¯ **Trigger**: ${{ github.event_name }}
          ðŸ†” **Run ID**: ${{ github.run_id }}"

          if git commit -m "$COMMIT_MSG"; then
            echo "âœ… Changes committed successfully"
            
            # Push with retry mechanism
            for i in {1..3}; do
              if git push origin main; then
                echo "ðŸŽ‰ README successfully updated and pushed!"
                echo "- **Commit**: âœ… Pushed to main branch" >> $GITHUB_STEP_SUMMARY
                echo "- **Attempts**: $i/3" >> $GITHUB_STEP_SUMMARY
                break
              else
                echo "âš ï¸ Push attempt $i failed, retrying..."
                sleep 2
                if [ $i -eq 3 ]; then
                  echo "âŒ All push attempts failed"
                  echo "- **Commit**: âŒ Push failed after 3 attempts" >> $GITHUB_STEP_SUMMARY
                  exit 1
                fi
              fi
            done
          else
            echo "âŒ Failed to commit changes"
            exit 1
          fi

      - name: ðŸ“Š Workflow Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ Final Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Changes Detected | ${{ steps.check_changes.outputs.changed || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Runtime | ${{ steps.update_start_time.outputs.duration || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Next Scheduled Run | Every 2 hours |" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“„ Updated README](https://github.com/${{ github.repository }}#readme)" >> $GITHUB_STEP_SUMMARY
          echo "- [âš™ï¸ Workflow File](https://github.com/${{ github.repository }}/blob/main/.github/workflows/update-readme.yml)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“œ Action History](https://github.com/${{ github.repository }}/actions/workflows/update-readme.yml)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ”§ Manual Trigger](https://github.com/${{ github.repository }}/actions/workflows/update-readme.yml)" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Workflow completed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Workflow encountered issues. Check logs above.**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "ðŸ•’ **Completed at**: $(date -u)" >> $GITHUB_STEP_SUMMARY
